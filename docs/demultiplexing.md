# Demultiplexing

NGS runfolders that satisfy the following criteria are demultiplexed by `demultiplexing.py`:

1. `RTAcomplete.txt` is present, indicating that sequencing is complete.
2.`bcl2fastq2_output.log` is absent, indicating that demultiplexing has not been performed
3. A samplesheet named after the runfolder name is present in the `samplesheets/` folder
4. Samplesheet passes the tests carried out by [samplesheet_validator.py](samplesheet_validator.py)

## Protocol
When a runfolder meets these criteria, the script compares the md5 checksums generated by 
the [integrity checking script](https://github.com/moka-guys/integrity_checking/blob/master/sequencer_checksum.py). This
verifies the integrity between the workstation and sequencer. If the integrity check passes, samples are demlutiplexed 
using bcl2fastq2 (v2.20).

## Configuration

Settings are imported from `automate_demultiplex_config.py`.

## Logging

| Alias | Description | Filename | Location |
|------|----------|---------|-----------|
|Demultiplex Log|Records the decisions made for multiple runfolders each time the script is run|`TIMESTAMP_RUNFOLDER-NAME_demultiplex_script_log.txt`| /usr/local/src/mokaguys/automate_demultiplexing_logfiles/Demultiplexing_log_files/ |
|Bcl2fastq output| STDOUT and STDERR from bcl2fastq | `bcl2fastq2_output.log` | Within the runfolder |
|Demultiplex output| STDERR and STDOUT from demultiplexing script. Includes errors from the cronjob | `TIMESTAMP.txt` | /usr/local/src/mokaguys/automate_demultiplexing_logfiles/Demultiplexing_stdout |

## Alerts

Logs from this script containing the follow strings will trigger alerts to the #moka-alerts binfx slack channel:

* demultiplex_fail
* smartsheet_fail
* samplesheet_warning