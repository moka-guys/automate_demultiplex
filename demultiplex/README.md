# Demultiplexing

The [demultiplex.py](../demultiplex.py) script performs the following:

1. Demultiplexing
2. Cluster density calculation

It contains 2 classes:
- GetRunfolders
- DemultiplexRunfolder

## Protocol

1. The `GetRunfolders()` class collects runfolders in the config-specified runfolders directory
2. `GetRunfolders.setoff_processing()` is called to:
-  Check if `bcl2fastq2` and `gatk` (used for cluster density calcs) are installed on the workstation
- Initiate runfolder processing per identified runfolder, on runfolders that have an absent bcl2fastq2 logfile (`bcl2fastq2_output.log` - denotes that demultiplexing has been performed). bcl2fastq2 stdout and stderr streams are written to this file
3. If criteria 2 is met, `DemultiplexRunfolder().setoff_workflow()` is called which performs a set of further checks on the runfolder to determine whether demultiplexing is required:
- Sequencing is complete (presence of `RTAComplete.txt` file created by the sequencer when sequencing is complete)
- Samplesheet does not contain any errors that would cause demultiplexing to fail - checks are carried out by the [samplesheet_validator.py](../samplesheet_validator/samplesheet_validator.py) module which makes use of the [seglh-naming](https://github.com/moka-guys/seglh-naming) library. The absence of error messages for specific tests is checked:
   * Sample sheet is present
   * Samplesheet name is valid (validates using the [seglh-naming](https://github.com/moka-guys/seglh-naming) library)
   * Samplesheet is not empty
   * Samplesheet contains the minimum expected `[Data]` section headers: `Sample_ID, Sample_Name, index`
   * Sample name does not contain any illegal characters (in case this was not rectified after the early warning checks as this will cause bcl2fastq2 to fail)
- If the sequencer does not require an integrity check, it skips straight to `run_demultiplexing()`
- If the sequencer does require an integrity check the following requirements must be met for `run_demultiplexing()` to be called:
  1. Checksum file generated by [integrity checking script
  ](https://github.com/moka-guys/integrity_checking/blob/master/sequencer_checksum.py)
must be present
  2. The run has not failed a previous integrity check performed by this script
  3. The md5 checksums in the checksum file match. This verifies the integrity between the workstation and sequencer
4. If criteria 3 are met, the demultiplexing log file is created to prevent simultaneous attempt on the next run of the script (bcl2fastq2 is slow to create the logfile), and the cluster density calculations are performed
5. If criteria 4 is met, and the run is not a tso run, `run_demultiplexing()` then executes the demultiplexing `bcl2fastq2 (v2.20)` command

## Usage

The module can be used either from the command line or as a module import:

```bash
python3 -m demultiplex
```

```python
from demultiplex import demultiplex

gr_obj = demultiplex.GetRunfolders()
gr_obj.setoff_processing()
```

## Configuration

Settings are imported from [ad_config.py](../config/ad_config.py).

## Logging

Logging is performed using [ad_logger](../ad_logger/ad_logger.py).

| Alias | Description | Filename | Location |
| ------------------ | ------------------------------------------------------------------------------ | ----------------------------------------------------- | ---------------------------------------------------------------------------------- |
| Demultiplex output | Catches any traceback from errors when running the cron job that are not caught by exception handling within the script | `TIMESTAMP.txt` | `/usr/local/src/mokaguys/automate_demultiplexing_logfiles/Demultiplexing_stdout` |
| script_logger | Records script-level logs for the demultiplex script | `TIMESTAMP_demultiplex_script_log.log` | `/usr/local/src/mokaguys/automate_demultiplexing_logfiles/demultiplexing_script_logfiles/` |
| demux_rf_logger | Records runfolder-level logs for the demultiplex script | `RUNFOLDERNAME_demultiplex_script_log.log` | `/usr/local/src/mokaguys/automate_demultiplexing_logfiles/demultiplexing_script_logfiles/` |
 Bcl2fastq output | STDOUT and STDERR from bcl2fastq2 | `bcl2fastq2_output.log` | Within the runfolder |

## Testing

**N.B. Tests and test cases/files MUST be maintained and updated accordingly in conjunction with script development**

Test datasets are stored in [/test/data](../test/data). The script has a full test suite:
* [test_demultiplex.py](../test/test_demultiplex.py)
  
These tests should be run before pushing any code to ensure all tests in the GitHub Actions workflow pass.
